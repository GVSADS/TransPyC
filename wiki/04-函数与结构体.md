# 函数与结构体

## 函数定义

### 基本语法

```python
import t

def add(a: t.CInt, b: t.CInt) -> t.CInt:
    return a + b
```

编译后：

```c
int add(int a, int b) {
    return (a + b);
}
```

### 无参数函数

```python
import t

def get_value() -> t.CInt:
    return 42
```

编译后：

```c
int get_value(void) {
    return 42;
}
```

### 无返回值函数

```python
import t

def print_hello() -> t.CVoid:
    # 函数体
    pass
```

编译后：

```c
void print_hello(void) {
}
```

### 指针参数

```python
import t

def swap(a: t.CInt | t.CPtr, b: t.CInt | t.CPtr) -> t.CVoid:
    temp: t.CInt = a[0]
    a[0] = b[0]
    b[0] = temp
```

编译后：

```c
void swap(int* a, int* b) {
    int temp = a[0];
    a[0] = b[0];
    b[0] = temp;
}
```

### 数组参数

```python
import t

def sum_array(arr: t.CInt[10]) -> t.CInt:
    total: t.CInt = 0
    for i in range(10):
        total = total + arr[i]
    return total
```

编译后：

```c
int sum_array(int arr[10]) {
    int total = 0;
    for (int i = 0; i < 10; i += 1) {
        total = (total + arr[i]);
    }
    return total;
}
```

### 变长数组参数

```python
import t

def sum_array(arr: t.CPtr | t.CInt, n: t.CInt) -> t.CInt:
    total: t.CInt = 0
    for i in range(n):
        total = total + arr[i]
    return total
```

编译后：

```c
int sum_array(int* arr, int n) {
    int total = 0;
    for (int i = 0; i < n; i += 1) {
        total = (total + arr[i]);
    }
    return total;
}
```

## 结构体定义

### 基本语法

```python
import t

class Point(t.CStruct):
    x: t.CInt
    y: t.CInt
```

编译后：

```c
struct Point {
    int x;
    int y;
};
```

### 带初始值的结构体

```python
import t

class Point(t.CStruct):
    x: t.CInt = 0
    y: t.CInt = 0
```

编译后：

```c
struct Point {
    int x;
    int y;
};
```

### 嵌套结构体

```python
import t

class Point(t.CStruct):
    x: t.CInt
    y: t.CInt

class Rectangle(t.CStruct):
    top_left: Point
    bottom_right: Point
```

编译后：

```c
struct Point {
    int x;
    int y;
};

struct Rectangle {
    struct Point top_left;
    struct Rectangle bottom_right;
};
```

### 结构体指针成员

```python
import t

class Node(t.CStruct):
    data: t.CInt
    next: t.CStruct(name="Node") | t.CPtr
```

编译后：

```c
struct Node {
    int data;
    struct Node* next;
};
```

### 匿名结构体

```python
import t

class Data(t.CStruct):
    type: t.CInt
    value: t.CStruct(name="")  # 匿名结构体
```

## 结构体使用

### 结构体变量

```python
import t

class Point(t.CStruct):
    x: t.CInt
    y: t.CInt

def main() -> t.CInt:
    # 结构体变量
    p: Point
    p.x = 10
    p.y = 20
    
    return 0
```

编译后：

```c
struct Point {
    int x;
    int y;
};

int main(void) {
    struct Point p;
    p.x = 10;
    p.y = 20;
    
    return 0;
}
```

### 结构体指针

```python
import t

class Point(t.CStruct):
    x: t.CInt
    y: t.CInt

def main() -> t.CInt:
    # 结构体指针
    p: Point | t.CPtr
    p.x = 10  # 生成 p->x = 10
    p.y = 20  # 生成 p->y = 20
    
    return 0
```

编译后：

```c
struct Point {
    int x;
    int y;
};

int main(void) {
    struct Point* p;
    p->x = 10;
    p->y = 20;
    
    return 0;
}
```

### 结构体数组

```python
import t

class Point(t.CStruct):
    x: t.CInt
    y: t.CInt

def main() -> t.CInt:
    # 结构体数组
    points: Point[10]
    points[0].x = 1
    points[0].y = 2
    
    return 0
```

编译后：

```c
struct Point {
    int x;
    int y;
};

int main(void) {
    struct Point points[10];
    points[0].x = 1;
    points[0].y = 2;
    
    return 0;
}
```

## 成员访问运算符

### 自动选择运算符

TransPyC 会自动选择 `.` 或 `->` 运算符：

```python
import t

class Sheet(t.CStruct):
    buf: t.CPtr | t.CChar
    width: t.CInt
    height: t.CInt

class SHTCTL(t.CStruct):
    sheets: t.CPtr | t.CStruct(name="Sheet")[10]  # 指针数组
    top: t.CInt

def update(ctl: SHTCTL | t.CPtr) -> t.CVoid:
    # ctl 是指针，sheets 是指针数组
    # sheets[0] 是指针，所以使用 ->
    ctl.sheets[0].width = 100   # 生成 ctl->sheets[0]->width
```

编译后：

```c
struct Sheet {
    char* buf;
    int width;
    int height;
};

struct SHTCTL {
    struct Sheet* sheets[10];
    int top;
};

void update(struct SHTCTL* ctl) {
    ctl->sheets[0]->width = 100;
}
```

### 复杂示例

```python
import t

class FILEHANDLE(t.CStruct):
    buf: t.CChar | t.CPtr
    size: t.CInt
    pos: t.CInt

class TASK(t.CStruct):
    fhandle: t.CStruct(name="FILEHANDLE") | t.CPtr  # 单个指针
    fhandle2: t.CStruct(name="FILEHANDLE")          # 不是指针

def access(task: TASK | t.CPtr) -> t.CVoid:
    # fhandle 是指针，fhandle[i] 不是指针（因为不是数组）
    task.fhandle[0].size = 100      # 生成 task->fhandle[0].size
    
    # fhandle2 不是指针
    task.fhandle2.size = 200        # 生成 task->fhandle2.size
```

编译后：

```c
struct FILEHANDLE {
    char* buf;
    int size;
    int pos;
};

struct TASK {
    struct FILEHANDLE* fhandle;
    struct FILEHANDLE fhandle2;
};

void access(struct TASK* task) {
    task->fhandle[0].size = 100;
    task->fhandle2.size = 200;
}
```

## 类型转换（CType）

### 基本用法

```python
import t

def access_timer(reg: t.CPtr | t.CInt) -> t.CVoid:
    # 将整数转换为结构体指针
    timer = t.CType(reg[7], TIMER, t.CPtr)
    if timer.flags2 == 1:
        timer.flags2 = 0
```

编译后：

```c
void access_timer(int* reg) {
    if (((struct TIMER *)reg[7])->flags2 == 1) {
        ((struct TIMER *)reg[7])->flags2 = 0;
    }
}
```

### 多次使用

```python
import t

def update_timer(reg: t.CPtr | t.CInt) -> t.CVoid:
    # 多次使用类型转换
    if t.CType(reg[7], TIMER, t.CPtr).flags2 == 1:
        t.CType(reg[7], TIMER, t.CPtr).flags2 = 0
        t.CType(reg[7], TIMER, t.CPtr).timeout = 100
```

编译后：

```c
void update_timer(int* reg) {
    if (((struct TIMER *)reg[7])->flags2 == 1) {
        ((struct TIMER *)reg[7])->flags2 = 0;
        ((struct TIMER *)reg[7])->timeout = 100;
    }
}
```

## 联合体

### 基本语法

```python
import t

class Data(t.CUnion):
    i: t.CInt
    f: t.CFloat
    c: t.CChar[4]
```

编译后：

```c
union Data {
    int i;
    float f;
    char c[4];
};
```

### 使用联合体

```python
import t

class Data(t.CUnion):
    i: t.CInt
    f: t.CFloat

def main() -> t.CInt:
    d: Data
    d.i = 10
    d.f = 3.14
    
    return 0
```

编译后：

```c
union Data {
    int i;
    float f;
};

int main(void) {
    union Data d;
    d.i = 10;
    d.f = 3.14;
    
    return 0;
}
```

## 枚举

### 基本语法

```python
import t

class Color(t.CEnum):
    RED = 0
    GREEN = 1
    BLUE = 2
```

编译后：

```c
enum Color {
    RED = 0,
    GREEN = 1,
    BLUE = 2
};
```

### 自动赋值

```python
import t

class Color(t.CEnum):
    RED      # 自动赋值为 0
    GREEN    # 自动赋值为 1
    BLUE     # 自动赋值为 2
```

编译后：

```c
enum Color {
    RED,
    GREEN,
    BLUE
};
```

### 使用枚举

```python
import t

class Color(t.CEnum):
    RED = 0
    GREEN = 1
    BLUE = 2

def main() -> t.CInt:
    c: Color = Color.RED
    
    if c == Color.RED:
        return 0
    
    return 1
```

编译后：

```c
enum Color {
    RED = 0,
    GREEN = 1,
    BLUE = 2
};

int main(void) {
    enum Color c = RED;
    
    if ((c == RED)) {
        return 0;
    }
    
    return 1;
}
```
